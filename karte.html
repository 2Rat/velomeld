<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radwegemelder ‚Äì √ñffentliche Karte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --red: #E00000; --yellow: #E5A700; --green: #00A836;
      --gray: #3D4F58; --gray-mid: #8A9BA4; --white: #FFFFFF;
      --font: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: var(--font); color: var(--gray); }
    body { display: flex; flex-direction: column; }

    .header {
      background: var(--white); padding: 12px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); z-index: 1000;
      display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    }
    .header__brand { display: flex; flex-direction: column; }
    .header__title { font-weight: 800; font-size: 18px; letter-spacing: 3px; text-transform: uppercase; }
    .header__title span:first-child { color: #1A5FA8; }
    .header__title span:last-child { color: #2D8C28; }
    .header__subtitle { font-size: 10px; color: var(--gray-mid); font-weight: 500; }
    .header__stats { display: flex; gap: 12px; font-size: 13px; font-weight: 600; }
    .stat { display: flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; background: #f5f5f5; }
    .stat__dot { width: 10px; height: 10px; border-radius: 50%; }

    #map { flex: 1; min-height: 0; }

    .filters {
      position: absolute; top: 80px; left: 10px; z-index: 1000;
      display: flex; flex-direction: column; gap: 6px;
    }
    .filter-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 14px; border: 2px solid transparent; border-radius: 24px;
      background: var(--white); box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      font-family: var(--font); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; white-space: nowrap;
    }
    .filter-btn:hover { transform: scale(1.03); }
    .filter-btn.active { border-color: currentColor; }
    .filter-btn--problems { color: var(--red); }
    .filter-btn--problems.active { background: #FFF0F0; }
    .filter-btn--wishes { color: var(--yellow); }
    .filter-btn--wishes.active { background: #FFF8E0; }
    .filter-btn--positive { color: var(--green); }
    .filter-btn--positive.active { background: #EEFBF0; }
    .filter-btn--all { color: var(--gray); }
    .filter-btn--all.active { background: #F0F2F4; border-color: var(--gray); }
    .filter-count {
      background: currentColor; color: white; font-size: 11px;
      padding: 1px 7px; border-radius: 10px; min-width: 22px; text-align: center;
    }

    .leaflet-popup-content-wrapper { border-radius: 14px !important; box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important; padding: 0 !important; }
    .leaflet-popup-content { margin: 0 !important; min-width: 220px; }
    .popup { padding: 16px; }
    .popup__header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .popup__icon { font-size: 24px; }
    .popup__category { font-weight: 700; font-size: 14px; }
    .popup__badge { display: inline-block; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; color: white; }
    .popup__comment { margin-top: 10px; padding: 10px; background: #F7F8F9; border-radius: 10px; font-size: 13px; line-height: 1.5; color: #4A5568; }
    .popup__meta { margin-top: 10px; font-size: 11px; color: var(--gray-mid); }

    .marker-cluster-problems { background: rgba(224,0,0,0.25); }
    .marker-cluster-problems div { background: var(--red); color: white; font-weight: 700; font-family: var(--font); }
    .marker-cluster-wishes { background: rgba(229,167,0,0.25); }
    .marker-cluster-wishes div { background: var(--yellow); color: white; font-weight: 700; font-family: var(--font); }
    .marker-cluster-positive { background: rgba(0,168,54,0.25); }
    .marker-cluster-positive div { background: var(--green); color: white; font-weight: 700; font-family: var(--font); }
    .marker-cluster-all { background: rgba(61,79,88,0.2); }
    .marker-cluster-all div { background: var(--gray); color: white; font-weight: 700; font-family: var(--font); }

    .loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      z-index: 1000; background: white; padding: 20px 30px; border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15); font-weight: 600;
      display: flex; align-items: center; gap: 10px;
    }
    .loading__spinner { width: 20px; height: 20px; border: 3px solid #E5E7EB; border-top-color: #1A5FA8; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .info-box {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      z-index: 1000; background: white; padding: 10px 20px; border-radius: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12); font-size: 12px; color: var(--gray-mid);
      display: flex; align-items: center; gap: 8px; white-space: nowrap;
    }
    .info-box a { color: #1A5FA8; text-decoration: none; font-weight: 600; }

    /* Kommune-Banner */
    .kommune-banner {
      display: none; background: #1A5FA8; color: white; padding: 8px 20px;
      font-size: 13px; font-weight: 600; text-align: center;
      align-items: center; justify-content: center; gap: 8px;
    }
    .kommune-banner.active { display: flex; }
    .kommune-banner__name { font-size: 15px; }
    .kommune-banner__info { font-size: 11px; opacity: 0.8; }

    @media (max-width: 480px) {
      .header { padding: 10px 14px; }
      .header__title { font-size: 15px; letter-spacing: 2px; }
      .header__stats { gap: 6px; font-size: 11px; }
      .stat { padding: 3px 8px; }
      .filters { top: 70px; left: 6px; }
      .filter-btn { padding: 6px 10px; font-size: 12px; }
      .info-box { font-size: 11px; padding: 8px 14px; bottom: 10px; }
    }
  </style>
</head>
<body>

  <!-- Kommune-Banner (nur bei ?kommune=...) -->
  <div class="kommune-banner" id="kommuneBanner">
    üìç Radwegecheck <span class="kommune-banner__name" id="kommuneName"></span>
    <span class="kommune-banner__info" id="kommuneInfo"></span>
  </div>

  <div class="header">
    <div class="header__brand">
      <div class="header__title"><span>Radwege</span><span>melder</span></div>
      <div class="header__subtitle" id="subtitle">√ñffentliche Meldungskarte ¬∑ Saarland</div>
    </div>
    <div class="header__stats" id="stats"></div>
  </div>

  <div id="map"></div>

  <div class="filters">
    <button class="filter-btn filter-btn--all active" data-filter="all" onclick="setFilter('all')">
      üìç Alle <span class="filter-count" id="count-all">0</span>
    </button>
    <button class="filter-btn filter-btn--problems" data-filter="problems" onclick="setFilter('problems')">
      ‚ö†Ô∏è Probleme <span class="filter-count" id="count-problems">0</span>
    </button>
    <button class="filter-btn filter-btn--wishes" data-filter="wishes" onclick="setFilter('wishes')">
      üí¨ W√ºnsche <span class="filter-count" id="count-wishes">0</span>
    </button>
    <button class="filter-btn filter-btn--positive" data-filter="positive" onclick="setFilter('positive')">
      üëç Positiv <span class="filter-count" id="count-positive">0</span>
    </button>
  </div>

  <div class="loading" id="loading">
    <div class="loading__spinner"></div>
    Meldungen werden geladen‚Ä¶
  </div>

  <div class="info-box">
    üö≤ Mitmachen? <a href="https://2rat.github.io/velomeld/">Radwegemelder-App √∂ffnen</a>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const SUPABASE_URL = 'https://vimsikjyoupihogmquul.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpbXNpa2p5b3VwaWhvZ21xdXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTIyMjYsImV4cCI6MjA4NjAyODIyNn0._Foa5ZVr4nwoOlZ4T-ORX0U4sNUjgRJJRyBDHvHV2vo';

    const CATEGORIES = {
      problems: { label: 'Problem', color: '#E00000', emoji: '‚ö†Ô∏è',
        subs: { surface:{icon:'üï≥Ô∏è',label:'Oberfl√§che'}, narrow:{icon:'‚ÜîÔ∏è',label:'Engstelle'}, crossing:{icon:'üîÄ',label:'Kreuzung / Knoten'}, traverse:{icon:'üö∂',label:'Querung'}, conflict:{icon:'üí•',label:'Konflikte'}, parking:{icon:'üÖøÔ∏è',label:'Parken'}, signage:{icon:'ü™ß',label:'Wegweisung'}, lighting:{icon:'üí°',label:'Beleuchtung'}, construction:{icon:'üöß',label:'Baustelle'}, drainage:{icon:'üíß',label:'Entw√§sserung'}, other:{icon:'üìù',label:'Sonstiges'}, detour:{icon:'üîÑ',label:'Umleitung fehlt'} }
      },
      wishes: { label: 'Wunsch', color: '#E5A700', emoji: 'üí¨',
        subs: { new_path:{icon:'üõ§Ô∏è',label:'Radweg gew√ºnscht'}, bike_parking:{icon:'üîí',label:'Abstellanlage'}, tempo30:{icon:'üêå',label:'Tempo 30'}, traffic_light:{icon:'üö¶',label:'Ampelschaltung'}, bike_street:{icon:'üö≤',label:'Fahrradstra√üe'}, oneway:{icon:'‚Ü©Ô∏è',label:'Einbahnstra√üe √∂ffnen'} }
      },
      positive: { label: 'Positiv', color: '#00A836', emoji: 'üëç',
        subs: { good_infra:{icon:'‚≠ê',label:'Gute Infrastruktur'}, safe_crossing:{icon:'‚úÖ',label:'Sichere Querung'}, service:{icon:'üõ†Ô∏è',label:'Service'}, bike_friendly_stop:{icon:'‚òï',label:'Fahrradfreundliche Einkehr'} }
      }
    };

    function getSubInfo(cat, sub) {
      const c = CATEGORIES[cat];
      if (!c) return { icon: 'üìç', label: sub, color: '#888', catLabel: cat };
      const s = c.subs[sub];
      return { icon: s ? s.icon : c.emoji, label: s ? s.label : sub, color: c.color, catLabel: c.label };
    }

    function createMarkerIcon(color) {
      return L.divIcon({
        html: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="38" viewBox="0 0 28 38"><path d="M14 0C6.27 0 0 6.27 0 14c0 10.5 14 24 14 24s14-13.5 14-24C28 6.27 21.73 0 14 0z" fill="${color}" stroke="white" stroke-width="2"/><circle cx="14" cy="14" r="6" fill="white" opacity="0.9"/></svg>`,
        className: '', iconSize: [28, 38], iconAnchor: [14, 38], popupAnchor: [0, -34],
      });
    }

    const ICONS = { problems: createMarkerIcon('#E00000'), wishes: createMarkerIcon('#E5A700'), positive: createMarkerIcon('#00A836') };

    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
    let allReports = [], filteredByGeo = [], currentFilter = 'all', clusterGroup;
    let kommuneMode = false, kommuneName = '', gfPoly = null;

    // ‚îÄ‚îÄ‚îÄ URL-Parameter lesen ‚îÄ‚îÄ‚îÄ
    const params = new URLSearchParams(window.location.search);
    const paramKommune = params.get('kommune');
    const paramVon = params.get('von');
    const paramBis = params.get('bis');
    const paramTitel = params.get('titel');

    // ‚îÄ‚îÄ‚îÄ Map Init ‚îÄ‚îÄ‚îÄ
    const map = L.map('map', { center: [49.35, 6.85], zoom: 10, zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© <a href="https://openstreetmap.org">OpenStreetMap</a> ¬∑ <a href="https://2rat.github.io/velomeld/">2Rat Radwegemelder</a>', maxZoom: 19
    }).addTo(map);

    // ‚îÄ‚îÄ‚îÄ Kommune-Geofence laden ‚îÄ‚îÄ‚îÄ
    async function loadKommuneGeofence(name) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(name + ', Saarland, Deutschland')}&format=json&polygon_geojson=1&limit=1`, {
          headers: { 'User-Agent': '2Rat-Radwegemelder/1.0' }
        });
        const data = await res.json();
        if (!data.length) { console.warn('Kommune nicht gefunden:', name); return; }
        const r = data[0];
        kommuneName = r.display_name.split(',')[0];

        // Banner anzeigen
        document.getElementById('kommuneBanner').classList.add('active');
        document.getElementById('kommuneName').textContent = kommuneName;
        document.getElementById('subtitle').textContent = 'Meldungskarte ¬∑ ' + kommuneName;

        // Zeitraum im Banner
        if (paramVon || paramBis) {
          const vonStr = paramVon || '‚Ä¶';
          const bisStr = paramBis || '‚Ä¶';
          document.getElementById('kommuneInfo').textContent = '¬∑ Aktionszeitraum: ' + vonStr + ' bis ' + bisStr;
        }

        // Titel √ºberschreiben
        if (paramTitel) {
          document.getElementById('kommuneName').textContent = paramTitel;
          document.title = paramTitel + ' ‚Äì Radwegemelder';
        } else {
          document.title = 'Radwegecheck ' + kommuneName + ' ‚Äì Radwegemelder';
        }

        // Polygon zeichnen
        if (r.geojson && (r.geojson.type === 'Polygon' || r.geojson.type === 'MultiPolygon')) {
          gfPoly = L.geoJSON(r.geojson, {
            style: { color: '#1A5FA8', weight: 2, fillColor: '#1A5FA8', fillOpacity: 0.05, dashArray: '6,4' }
          }).addTo(map);
          map.fitBounds(gfPoly.getBounds(), { padding: [40, 40] });
        } else if (r.boundingbox) {
          const b = L.latLngBounds([+r.boundingbox[0], +r.boundingbox[2]], [+r.boundingbox[1], +r.boundingbox[3]]);
          gfPoly = L.rectangle(b, { color: '#1A5FA8', weight: 2, fillColor: '#1A5FA8', fillOpacity: 0.05, dashArray: '6,4' }).addTo(map);
          map.fitBounds(b, { padding: [40, 40] });
        }
        kommuneMode = true;
      } catch (e) { console.error('Geofence-Fehler:', e); }
    }

    // ‚îÄ‚îÄ‚îÄ Point-in-Polygon ‚îÄ‚îÄ‚îÄ
    function inGeo(lat, lng) {
      if (!kommuneMode || !gfPoly) return true;
      if (gfPoly.getLayers) {
        for (const ly of gfPoly.getLayers()) {
          if (ly.getLatLngs) {
            const rings = ly.getLatLngs();
            const flat = Array.isArray(rings[0][0]) ? rings.flat() : rings;
            for (const ring of flat) if (raycast(L.latLng(lat, lng), ring)) return true;
          } else if (ly.getBounds && ly.getBounds().contains([lat, lng])) return true;
        }
        return false;
      }
      return gfPoly.getBounds ? gfPoly.getBounds().contains([lat, lng]) : true;
    }
    function raycast(pt, poly) {
      let ins = false;
      for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        const yi = poly[i].lng, xi = poly[i].lat, yj = poly[j].lng, xj = poly[j].lat;
        if ((yi > pt.lng) !== (yj > pt.lng) && pt.lat < (xj - xi) * (pt.lng - yi) / (yj - yi) + xi) ins = !ins;
      }
      return ins;
    }

    // ‚îÄ‚îÄ‚îÄ Daten laden ‚îÄ‚îÄ‚îÄ
    async function loadReports() {
      try {
        const resp = await fetch(SUPABASE_URL + '/rest/v1/reports?select=*&order=timestamp.desc&limit=5000', { headers: { 'apikey': SUPABASE_KEY } });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        allReports = await resp.json();

        // Geofence-Filter
        filteredByGeo = allReports;
        if (kommuneMode) {
          filteredByGeo = allReports.filter(r => r.latitude && r.longitude && inGeo(r.latitude, r.longitude));
        }

        // Zeitraum-Filter
        if (paramVon) filteredByGeo = filteredByGeo.filter(r => r.timestamp && r.timestamp >= paramVon);
        if (paramBis) filteredByGeo = filteredByGeo.filter(r => r.timestamp && r.timestamp <= paramBis + 'T23:59:59');

        updateCounts();
        renderMarkers();

        if (!kommuneMode && filteredByGeo.length > 0) {
          const bounds = filteredByGeo.map(r => [r.latitude, r.longitude]);
          map.fitBounds(bounds, { padding: [40, 40], maxZoom: 15 });
        }
      } catch (err) {
        console.error('Fehler:', err);
        document.getElementById('loading').innerHTML = '‚ùå Meldungen konnten nicht geladen werden';
      }
      document.getElementById('loading').style.display = 'none';
    }

    // ‚îÄ‚îÄ‚îÄ Marker ‚îÄ‚îÄ‚îÄ
    function renderMarkers() {
      if (clusterGroup) map.removeLayer(clusterGroup);
      clusterGroup = L.markerClusterGroup({
        maxClusterRadius: 50, spiderfyOnMaxZoom: true, showCoverageOnHover: false,
        iconCreateFunction(cluster) {
          const count = cluster.getChildCount();
          const size = count < 10 ? 36 : count < 50 ? 44 : 52;
          const cats = {};
          cluster.getAllChildMarkers().forEach(m => { if (m._cat) cats[m._cat] = (cats[m._cat]||0) + 1; });
          const top = Object.entries(cats).sort((a,b) => b[1]-a[1])[0];
          const col = top ? ({problems:'#E00000',wishes:'#E5A700',positive:'#00A836'}[top[0]] || '#3D4F58') : '#3D4F58';
          return L.divIcon({
            html: '<div style="width:' + (size-10) + 'px;height:' + (size-10) + 'px;line-height:' + (size-10) + 'px;text-align:center;border-radius:50%;background:' + col + ';color:white;font-weight:700;font-family:DM Sans,sans-serif;font-size:13px;">' + count + '</div>',
            className: '', iconSize: [size, size],
          });
        }
      });

      const filtered = currentFilter === 'all' ? filteredByGeo : filteredByGeo.filter(r => r.category === currentFilter);

      filtered.forEach(r => {
        const info = getSubInfo(r.category, r.subcategory);
        const icon = ICONS[r.category] || ICONS.problems;
        const marker = L.marker([r.latitude, r.longitude], { icon });
        marker._cat = r.category;
        const dateStr = new Date(r.timestamp).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        marker.bindPopup(`<div class="popup"><div class="popup__header"><span class="popup__icon">${info.icon}</span><div><div class="popup__category">${info.label}</div><span class="popup__badge" style="background:${info.color}">${info.catLabel}</span></div></div>${r.comment ? '<div class="popup__comment">' + escapeHtml(r.comment) + '</div>' : ''}<div class="popup__meta">üìÖ ${dateStr}</div></div>`);
        clusterGroup.addLayer(marker);
      });
      map.addLayer(clusterGroup);
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter));
      renderMarkers();
    }

    function updateCounts() {
      const counts = { all: filteredByGeo.length, problems: 0, wishes: 0, positive: 0 };
      filteredByGeo.forEach(r => { if (counts[r.category] !== undefined) counts[r.category]++; });
      Object.entries(counts).forEach(([key, count]) => { const el = document.getElementById('count-' + key); if (el) el.textContent = count; });
      document.getElementById('stats').innerHTML = `
        <div class="stat"><div class="stat__dot" style="background:var(--red)"></div>${counts.problems}</div>
        <div class="stat"><div class="stat__dot" style="background:var(--yellow)"></div>${counts.wishes}</div>
        <div class="stat"><div class="stat__dot" style="background:var(--green)"></div>${counts.positive}</div>`;
    }

    function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }

    // ‚îÄ‚îÄ‚îÄ Start ‚îÄ‚îÄ‚îÄ
    async function init() {
      // Wenn Kommune-Parameter da ‚Üí erst Geofence laden, dann Meldungen
      if (paramKommune) {
        await loadKommuneGeofence(paramKommune);
      }
      await loadReports();
    }
    init();

    // Auto-Refresh alle 60 Sekunden
    setInterval(loadReports, 60000);
  </script>
</body>
</html>
